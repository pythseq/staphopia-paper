---
title: "Results Section: Antibiotic Resistance Patterns"
output:
  pdf_document: default
---
```{r}
library(staphopia)
library(ggplot2)
library(reshape2)
library(scales)
library(dplyr)
library(gridExtra)
produce_all_plots = FALSE
```

In this section we will look into resistance patterns *Staphylococcus aureus*.


# Aggregating Data For Public Samples
First we'll get all publicly available *S. aureus* samples.

```{r}
ps <- get_public_samples()
```

# MRSA and MSSA
We defined MRSA by the presence of the *mecA*. Samples which did not have evidence for *mecA* were classified as MSSA.

## Primer based classification
First we'll use the results from the primer based SCCmec classification to identify samples with full matches to the *mecA* primers. It is important to note these results will only identify SCCmec types containing *mecA* (Example: SCCmec Xi has *mecC* and will not be included in these)

### Strict (Full Hits Only)
```{r}
sccmec_primer <- get_sccmec_type(ps$sample_id)
table(sccmec_primer$meca)
```

```{r}
sccmec_counts <- as.data.frame(colSums(sccmec_primer[,2:11]))
colnames(sccmec_counts) <- c('Total')
sccmec_counts <- data.frame(Type=rownames(sccmec_counts),
                            Total=sccmec_counts$Total)
sccmec_counts
```

### Relaxed (Hamming Distance)
```{r}
sccmec_type_hd <- get_sccmec_type(ps$sample_id, 
                                  hamming = TRUE)
table(sccmec_type_hd$meca)
```

## Protein Based Classification

```{r}
sccmec_proteins <- get_sccmec_protein_hits(ps$sample_id)
max_score <- group_by(sccmec_proteins,target) %>%
             summarise(maxscore = max(bitscore))
sccmec_proteins <- merge(sccmec_proteins, max_score,
                         by='target')
```

```{r}
sccmec_proteins$BSR <- sccmec_proteins$bitscore / sccmec_proteins$maxscore
table(sccmec_proteins[sccmec_proteins$BSR >0.95,]$target)
```

```{r fig.width=12, fig.asp=0.4}
p <- ggplot(data=sccmec_proteins[sccmec_proteins$BSR > 0.95],
            aes(x=target)) +
    ylab("Count") +
    xlab("SCCmec Target") +
    geom_bar() +
    theme_bw() +
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=14,face="bold"),
          legend.title = element_blank())
p
```

```{r fig.width=12, fig.asp=0.4}
a <- sccmec_proteins[sccmec_proteins$target =='mecA',]
sccmec_proteins_mec <- data.frame(sample_id=a$sample_id, BSR=a$BSR)
sccmec_proteins_mec$mec <- ifelse(
    sccmec_proteins_mec$BSR >= 0.95, TRUE, FALSE
)
p <- ggplot(data=sccmec_proteins_mec, aes(x=BSR)) +
    xlab("Blast Score Ratio") +
    ylab("Count") +
    geom_histogram(binwidth = 0.025) +
    theme_bw() +
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=14,face="bold"),
          legend.title = element_blank())
p
```

```{r fig.width=12, fig.asp=0.4}
a <- hist(sccmec_proteins_mec$BSR, plot=FALSE)
meca_bsr <- data.frame(
    region=sapply(1:length(a$counts), function(x){
        paste0(a$breaks[x], " - ",a$breaks[x+1])
    }), 
    count=a$counts
)
meca_bsr
```

## Ariba based classification
We can use the results from Ariba (via MEGARes) to identify samples with predicted resistance to methicillin. We will do this in two ways, first by only looking at results with a match (strict), and the other being those results that include partial assemblies (relaxed). A reminder, the Ariba results only include samples with paired end reads.

### Strict
These results are based on the a match to a SCCmec related cluster.
```{r}
ariba <- get_sccmec_ariba(ps$sample_id, resistance_report = TRUE)
```
```{r} 
table(ariba$mec)
```
### Relaxed
These results allow for partial matches to a SCCmec related cluster.
```{r}
ariba_relaxed <- get_sccmec_ariba(ps$sample_id,
                                  resistance_report = TRUE,
                                  include_all=TRUE)
```
```{r}
table(ariba_relaxed$mec)
```

## SCCmec Cassette Coverage
```{r}
sccmec_coverage <- get_sccmec_cassette_coverages(ps$sample_id)
```

### Group By Most Covered SCCmec Type
```{r Table Top SCCmec Type Mapping}
top_type <- sccmec_coverage %>% group_by(sample_id) %>% slice(
    which.max(total)
)
table(top_type[top_type$total > 0.5,]$cassette)
```

```{r}
length(top_type[top_type$total > 0.5,]$cassette)
```

### Group By Most Covered *mec* Region
```{r}
top_mec <- sccmec_coverage %>% group_by(sample_id) %>% slice(
    which.max(meca_total)
)
table(top_mec[top_type$total > 0.5,]$cassette)
```

#### Plot Of Top SCCmec Covered and *mec* Region Covered

##### *mec* Predicted By Primers
```{r Figure SCCmec Primer, fig.width=12, fig.asp=0.4}
p <- ggplot(data=merge(top_type, sccmec_primer, by='sample_id'),
            aes(total, meca_total, colour = meca)) + 
        ylab("mec Region Covered") +
        xlab("Top SCCmec Type Covered") +
        geom_point() +
        scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
        theme_bw() +
        theme(axis.text=element_text(size=12),
              axis.title=element_text(size=14,face="bold"),
              legend.title = element_blank())
p

# Output plot to PDF and PNG
# staphopia::write_plot(p, paste0(getwd(), '/images/figure-x-sccmec-coverage-primer'))
```

##### *mec* Predicted By Ariba (Strict)
```{r Figure SCCmec Ariba, fig.width=12, fig.asp=0.4}
p <- ggplot(data=merge(top_type, ariba, by='sample_id'),
            aes(total, meca_total, colour = mec)) + 
        ylab("mec Region Covered") +
        xlab("Top SCCmec Type Covered") +
        geom_point() +
        scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
        theme_bw() +
        theme(axis.text=element_text(size=12),
              axis.title=element_text(size=14,face="bold"),
              legend.title = element_blank())
p

# Output plot to PDF and PNG
# staphopia::write_plot(p, paste0(getwd(), '/images/figure-x-sccmec-coverage-ariba'))
```

##### *mec* Predicted By Ariba (Relaxed)
```{r fig.width=12, fig.asp=0.4}
p <- ggplot(data=merge(top_type, ariba_relaxed, by='sample_id'),
            aes(total, meca_total, colour = mec)) + 
        ylab("mec Region Covered") +
        xlab("Top SCCmec Type Covered") +
        geom_point() +
        scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
        theme_bw() +
        theme(axis.text=element_text(size=12),
              axis.title=element_text(size=14,face="bold"),
              legend.title = element_blank())
p

# Output plot to PDF and PNG
# staphopia::write_plot(p, paste0(getwd(), '/images/figure-x-sccmec-coverage-ariba-relaxed'))
```

#### Plot Of SCCmec Covered and Top *mec* Region Covered

##### *mec* Predicted By Primers
```{r fig.width=12, fig.asp=0.4}
p <- ggplot(data=merge(top_mec, sccmec_primer, by='sample_id'),
            aes(total, meca_total, colour = meca)) + 
        ylab("Top mec Region Covered") +
        xlab("SCCmec Type Covered") +
        geom_point() +
        scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
        theme_bw() +
        theme(axis.text=element_text(size=12),
              axis.title=element_text(size=14,face="bold"),
              legend.title = element_blank())
p
```

##### *mec* Predicted By Ariba (Strict)
```{r fig.width=12, fig.asp=0.4}
p <- ggplot(data=merge(top_mec, ariba, by='sample_id'),
            aes(total, meca_total, colour = mec)) + 
        ylab("Top mec Region Covered") +
        xlab("SCCmec Type Covered") +
        geom_point() +
        scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
        theme_bw() +
        theme(axis.text=element_text(size=12),
              axis.title=element_text(size=14,face="bold"),
              legend.title = element_blank())
p
```

##### *mec* Predicted By Ariba (Relaxed)
```{r fig.width=12, fig.asp=0.4}
p <- ggplot(data=merge(top_mec, ariba_relaxed, by='sample_id'),
            aes(total, meca_total, colour = mec)) + 
        ylab("Top mec Region Covered") +
        xlab("SCCmec Type Covered") +
        geom_point() +
        scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
        theme_bw() +
        theme(axis.text=element_text(size=12),
              axis.title=element_text(size=14,face="bold"),
              legend.title = element_blank())
p
```

#### Plot of Each SCCmec Type Individually
##### Function For Plotting
```{r}
plot_by_sccmectype <- function(coverage, column) {
    p <- ggplot(data=coverage,
                aes(x=total, y=meca_total, colour = mec)) +
        ylab("mec Region Covered") +
        xlab(paste0("SCCmec Type ", column," Covered")) +
        geom_point() +
        scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
        theme_bw() +
        theme(axis.text=element_text(size=12),
              axis.title=element_text(size=14,face="bold"),
              legend.title = element_blank())
    return(p)
}
```

#### Each SCCmec Type Individually (Colored By Ariba (Strict))
```{r fig.width=12, fig.asp=0.4}
if (produce_all_plots) {
    for (column in unique(sccmec_coverage$cassette)) {
        print(plot_by_sccmectype(
            merge(sccmec_coverage[sccmec_coverage$cassette == column,],
                  ariba, 
                  by='sample_id'),
            column
        ))
    }
}
```

#### Each SCCmec Type Individually (Colored By Ariba (Relaxed))
```{r fig.width=12, fig.asp=0.4}
if (produce_all_plots) {
    for (column in unique(sccmec_coverage$cassette)) {
        print(plot_by_sccmectype(
            merge(sccmec_coverage[sccmec_coverage$cassette == column,],
                  ariba_relaxed, 
                  by='sample_id'),
            column
        ))
    }
}
```

#### Compare *mec* Predictions
```{r}
mec <- merge(
    ps, 
    data.frame(
        sample_id=sccmec_proteins_mec$sample_id,
        protein_mec=sccmec_proteins_mec$mec
    ), 
    by='sample_id', 
    all=TRUE
)
mec[is.na(mec$protein_mec),]$protein_mec <- FALSE
mec <- merge(mec, data.frame(
    sample_id=sccmec_primer$sample_id, 
    primer_mec=sccmec_primer$meca
), by='sample_id', all=TRUE)
mec <- merge(mec, data.frame(
    sample_id=ariba$sample_id, 
    ariba_mec=ariba$mec
), by='sample_id', all=TRUE)
mec <- merge(mec, data.frame(
    sample_id=ariba_relaxed$sample_id, 
    ariba_relaxed_mec=ariba_relaxed$mec
), by='sample_id', all=TRUE)
mec$agreement <- paste0(
    ifelse(mec$protein_mec, 1, 0),
    ifelse(mec$primer_mec, 1, 0),
    ifelse(is.na(mec$ariba_mec), '-', ifelse(
        mec$ariba_mec, 1, 0
    )),
    ifelse(is.na(mec$ariba_relaxed_mec), '-', ifelse(
        mec$ariba_relaxed_mec, 1, 0
    ))
)
table(mec$agreement)
```

*Notes*

* 0: **mec** not predicted
* 1: **mec** predicted
* -: Not tested by Ariba (Single-End reads)

The order of numbering is:

* 1: **mecA** with BSR > 0.95 based on Proteins
* 2: **mecA** with full Primer hit
* 3: **mec** with full match based on Ariba
* 4: **mec** with partial match based on Ariba

Example:

* 00-- : Single-End, Protein and Primer are False
* 0000 : All approaches agree that **mec** is not predicted
* 1111 : All approaches agree that **mec** is predicted

```{r}
mec <- merge(mec, data.frame(
    sample_id=top_type$sample_id, 
    total=top_type$total
), by='sample_id')
mec <- merge(mec, data.frame(
    sample_id=top_type$sample_id, 
    mec_total=top_type$meca_total
), by='sample_id')
table(mec[mec$total >= 0.5,]$primer_mec)
```
```{r}
table(mec[mec$total >= 0.5,]$protein_mec)
```

```{r}
table(mec[mec$total >= 0.5,]$ariba_mec)
```

```{r}
table(mec[mec$total >= 0.5,]$ariba_relaxed_mec)
```

SCCmec cassettes with 50% coverage but 0% in *mec* region.
```{r}
table(mec[mec$total >= 0.5 & mec$mec_total == 0,]$ariba_mec)
```

#### *mecA* Presence By ST
```{r}
meca_groups <- merge(
    data.frame(
        sample_id=ps$sample_id, 
        st=ps$st, 
        rank=ps$rank
    ),
    ariba,
    by='sample_id'
)
meca_groups$status <- ifelse(
    meca_groups$mec == TRUE, 'MRSA', 'MSSA'
)
meca_by_st <- plyr::count(meca_groups, c('st', 'status'))
head(meca_by_st)
```

#### Get the Top 10 STs
```{r}
top_st <- get_top_sequence_types()
top_st
```

#### MRSA/MSSA Distribution For Top 10 Sequence Types
Now we are ready to plot out the distribution of MRSA and MSSA predictions by sequence type.

```{r Figure 6 MRSA TopST, fig.width=12, fig.asp=0.4}
top_st_meca <- merge(top_st, meca_by_st, by='st')
p <- ggplot(data=top_st_meca, aes(x=reorder(st, -count), y=freq,
                                  fill = status)) +
    xlab("Sequence Type") +
    ylab("Count") +
    geom_bar(stat="identity", position = "dodge") +
    geom_text(aes(label=freq), vjust = -0.5,
              position = position_dodge(.9)) + 
    scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
    theme_bw() +
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=14,face="bold"),
          legend.title = element_blank())
p

# Output plot to PDF and PNG
staphopia::write_plot(p, paste0(getwd(), '/../figures/figure-06-mrsa-top-10-sequence-types'))
```

### Resistance Patterns Based on Ariba and MegaRes

#### Resistance Classes With A Match
```{r}
resistance_report <- get_resistance_results(ps$sample_id,
                                            resistance_report=TRUE)
df <- as.data.frame(colSums(
    resistance_report[,2:ncol(resistance_report)]
))
colnames(df) <- c('total')
resistance_report_counts <- data.frame(
    class=rownames(df),
    total=df$total
)
resistance_report_counts[resistance_report_counts$total > 0,]
```

#### Resistance Classes Without A Match
```{r}
data.frame(class=as.character(
    resistance_report_counts[resistance_report_counts$total == 0,]$class
))
```

```{r}
cluster_report <- get_resistance_results(ps$sample_id,
                                         cluster_report=TRUE)
df <- as.data.frame(colSums(
    cluster_report[,2:ncol(cluster_report)]
))
colnames(df) <- c('total')
cluster_report_counts <- data.frame(
    cluster=rownames(df),
    total=df$total
)
cluster_report_counts[cluster_report_counts$total > 0,]
```

#### Resistance Clusters Without A Match
```{r}
data.frame(class=as.character(
    cluster_report_counts[cluster_report_counts$total == 0,]$cluster
))
```


#### Group
```{r}
resistance_groups <- merge(
    data.frame(sample_id=ps$sample_id, st=ps$st, rank=ps$rank),
    resistance_report,
    by='sample_id'
)
```

#### By ST

#### Function For Plotting
```{r}
plot_by_st <- function(group, top_st, column) {
    by_st <- plyr::count(
        group, 
        c('st',
          ifelse(
              length(strsplit(column, ' ')[[1]]) >= 2, 
              paste0("`", column, "`"), 
              column
          )
        )
    )
    by_st$status <- ifelse(
        by_st[,make.names(column)] == TRUE, 'Resistant', 'Susceptible'
    )
    top_st_resistance <- merge(top_st, by_st, by='st')
    p <- ggplot(data=top_st_resistance, aes(x=reorder(st, -count),
                                            y=freq, fill = status)) +
        xlab("Sequence Type") +
        ylab(paste0("Count")) +
        geom_bar(stat="identity", position = "dodge") +
        geom_text(aes(label=freq), vjust = -0.5,
                  position = position_dodge(.9)) + 
        scale_fill_manual(values=c("#2ca25f", "#5ab4ac"),
                          name = column) +
        theme_bw() +
        theme(axis.text=element_text(size=12),
              axis.title=element_text(size=14,face="bold"),
              legend.position="top")
    return(p)
}
```

#### Resistance Classes With A Match By Top 10 Sequence Types
```{r fig.width=12, fig.asp=0.4}
top_st <- get_top_sequence_types()
plots <- list()
i <- 1
for (column in sort(as.character(
        resistance_report_counts[resistance_report_counts$total > 0,]$class
    ))) {
    p <- plot_by_st(resistance_groups, top_st, column)
    print(column)
    print(p)
    if (column == 'Fosfomycin' | column == 'Aminoglycosides' | column == 'MLS') {
        plots[[i]] <- p
        i <- i + 1
    } 
}
```

```{r figure 7, fig.width=12, fig.asp=1.5}
grid.arrange(grobs=plots)
# Output plot to PDF and PNG
pdf(paste0(
    getwd(),
    '/../figures/figure-07-resistance-facet-top-10-sequence-types.pdf'
), height=15, width=12)
grid.arrange(grobs=plots)
dev_null <- dev.off()

png(paste0(
    getwd(),
    '/../figures/figure-07-resistance-facet-top-10-sequence-types.png'
), height=1200, width=1200)
grid.arrange(grobs=plots)
dev_null <- dev.off()
```


## Session Info
```{r}
sessionInfo()
```
