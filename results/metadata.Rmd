---
title: "Results Section: Public Metadata"
output:
  pdf_document: default
---
```{r}
library(staphopia)
library(ggplot2)
library(reshape2)
USE_DEV = TRUE
```

## Aggregating Data For Public Samples
First we'll get all publicly available *S. aureus* samples.

```{r}
ps <- get_public_samples()
```

We will also get information pertaining to submissions by year.
```{r}
submissions <- get_submission_by_year()
```

We now have `r toString(nrow(ps))` samples to work with. Next we will acquire
metadata associated with each sample.

```{r}
metrics <- merge(
    ps, 
    get_metadata(ps$sample_id),
    by='sample_id'
)
```

We are now going to add two columns `rank_name` and `year`.
```{r}
metrics$year <- sapply(
    metrics$first_public,
    function(x) {
        strsplit(x, "-")[[1]][1]
    }
)

metrics$rank_name <- ifelse(
    metrics$rank.x == 3,
    'Gold',
    ifelse(
        metrics$rank.x == 2,
        'Silver',
        'Bronze'
    )
)
```

## Visualizing Metrics
The following sections will be plots to visualize relationships in the data.

#### Published vs Unpublished Submissions Per Year
```{r fig.width=12, fig.asp=0.5}
melted <- melt(submissions, id=c('year'),
               measure.vars = c('published', 'unpublished'))
melted$title <- ifelse(melted$variable == 'published', 'Published', 'Unpublished')

title <- substitute(paste("Published (N = ", p, ") and unpubished (N = ", u, ") publicly available ",
                          italic('S. aureus')," samples between ", min_year, " and ", max_year, "."), 
    list(
        p=format(max(submissions$overall_published), big.mark=',', scientific=FALSE),
        u=format(max(submissions$overall_unpublished), big.mark=',', scientific=FALSE),
        min_year=min(submissions$year),
        max_year=max(submissions$year)
))
p <- ggplot(data=melted, aes(x=year, y=value, fill=title)) +
    xlab("Year") +
    ylab("Published and Unpublished Samples Per Year") +
    ggtitle(title) +
    geom_bar(stat='identity', position='dodge') +
    geom_text(aes(label=value), vjust = -0.5, position = position_dodge(.9)) +
    scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
    scale_x_continuous(breaks = round(seq(min(submissions$year), max(submissions$year), by = 1),1)) +
    theme_bw() +
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=14,face="bold"),
          legend.title = element_blank())
    

p
```

#### Overall Published vs Unpublished Submissions
```{r fig.width=12, fig.asp=0.5}
melted <- melt(submissions, id=c('year'),
               measure.vars = c('overall_published', 'overall_unpublished'))
melted$title <- ifelse(melted$variable == 'overall_published', 'Published', 'Unpublished')

title <- substitute(paste("Cumulative published (N = ", p, ") and unpubished (N = ", u, ") publicly available ",
                          italic('S. aureus')," samples between ", min_year, " and ", max_year, "."), 
    list(
        p=format(max(submissions$overall_published), big.mark=',', scientific=FALSE),
        u=format(max(submissions$overall_unpublished), big.mark=',', scientific=FALSE),
        min_year=min(submissions$year),
        max_year=max(submissions$year)
))
p <- ggplot(data=melted, aes(x=year, y=value, fill=title)) +
    xlab("Year") +
    ylab("Cumulative Published and Unpublished Samples Per Year") +
    ggtitle(title) +
    geom_bar(stat='identity', position='dodge') +
    geom_text(aes(label=value), vjust = -0.5, position = position_dodge(.9)) +
    scale_fill_manual(values=c("#2ca25f", "#5ab4ac")) +
    scale_x_continuous(breaks = round(seq(min(submissions$year), max(submissions$year), by = 1),1)) +
    theme_bw() +
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=14,face="bold"),
          legend.title = element_blank())
    

p
```

